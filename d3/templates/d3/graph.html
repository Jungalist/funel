{% load staticfiles %}
<!DOCTYPE html>
    <html lang = "en" >
    <head>
    <meta charset = "utf-8" >
    <title> D3 Test </title> 
    <script type = "text/javascript" src = "http://d3js.org/d3.v3.js" > </script> 
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    </head> 
    <style>
/*TODO download all libraries

*/
    
    .node {
        fill: #0066FF;
        stroke: #000;
        stroke-width: 2 px;
    }

    .link {
        stroke: #777;
        stroke-width: 2px;
    }

    .controls {
        right: 100px;
        position: fixed;
        top: 10px;
        width: 150px;
     }


    </style>
    
    <body>
        <div class="controls">
            <button type="button" id="reset" class="btn btn-secondary">Reset zoom</button>
            <button type="button" id="remove" class="btn btn-secondary">Remove linkless nodes</button>
        </div>

        <script type= "text/javascript" >
            //var color = d3.scale.category10();
            //var color = ['#339999', '#0033cc', '#00cc33', '#cc0000', '#000000']
            //var range = color.range();
            var color = ['#eff3ff', '#bdd7e7', '#6baed6','#3182bd','#08519c']
            var scale = d3.scale.ordinal().domain([0,40]).range(color); 


            $(document).ready(function(){
                //Load in the json file
                var data = {{ json | safe }};
                var width = screen.width;
                var height = screen.height;
                


                //Define force properties
                //Force, nodes and links loaded in and force started
                var force = d3.layout.force()
                    .charge(-100)
                    .linkDistance(3)
                    .size([width, height])
                    .nodes(data.nodes)
                    .links(data.links)
                    .start();

                //Add the svg
                var svg = d3.select("body")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .call(d3.behavior.zoom().on("zoom", function () {
                        svg.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")")
                    }))
                    .append("g");
                
                //Links
                var link = svg.selectAll(".link")
                    .data(data.links)
                    .enter().append("line")
                    .attr("class", "link");

                //Nodes
                var node = svg.selectAll(".node")
                    .data(data.nodes)
                    .enter().append("circle")
                    .attr("class", "node")
                    .attr("r", 5)
                    .call(force.drag);

                    node.append("title")
                    .text(function(d) {
                        return d.name;
                    });



               

                force.on("tick", function() {
                    link.attr("x1", function(d) {
                            return d.source.x;
                        })
                        .attr("y1", function(d) {
                            return d.source.y;
                        })
                        .attr("x2", function(d) {
                            return d.target.x;
                        })
                        .attr("y2", function(d) {
                            return d.target.y;
                        });

                    node.attr("cx", function(d) {
                            return d.x;
                        })
                        .attr("cy", function(d) {
                            return d.y;
                        });
                });

        
                //Width of the connection, take from strength value

                node.style("fill", function(d) {
                            return scale(d.weight);
                        });

                d3.select("#remove")
                    .on("click", removeLonelyNodes);

                d3.select("#reset")
                    .on("click", resetZoom);
            

                var scale2 = 0.5;
                function resetZoom() {
                    svg.attr("transform", "translate("+(width-scale*width)/2+","+(height-scale*height)/2+") scale("+scale2+")")
                }

                function removeLonelyNodes() {
                    node.filter(function(d){
                            if(d.weight==0){
                                return this;
                            }})
                        .remove();
                }
                
        });
    </script>

        
    </body> </html>
            
